<!DOCTYPE html>
<html>
<head>
    <title>Ingest Area Chart</title>
    <script src="js/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <link rel="stylesheet" href="css/custom.min.css" />
    <style type="text/css">
        html, body {
            height: 100%;
        }

        svg {
            font-size: 10px;
        }

        .axis {
            shape-rendering: crispEdges;
        }

            .axis path, .axis line {
                fill: none;
            }

        .x.axis path {
            stroke: #000;
        }

        .y.axis path {
            stroke: #000;
        }

        path.line {
            fill: none;
            stroke: #000;
            stroke-width: .5px;
        }

        rect.pane {
            cursor: e-resize;
            fill: none;
            pointer-events: all;
        }

        #chart-header > span {
            font-size: 14px;
        }

        #chart {
            height: 100%;
        }

        .top30{
            margin-top:30px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 text-center top30" id="chart-header">
                <p id="range"></p>
                <p id="total"></p>
            </div>
            <div class="col-md-12" id="chart">

            </div>
        </div>
    </div>

    <script>

        var x, y, xAxis, yAxis, area, svg, rect, format;

        function buildGraph() {
            var m = [79, 80, 160, 79], // Margin
                w = document.body.clientWidth - m[1] - m[3],
                parse = d3.time.format("%Y-%m-%d %H:%M").parse;

            var h = 300;

            if (document.body.clientHeight > 300)
                h = document.body.clientHeight;

            h = h - m[0] - m[2],

                format = d3.time.format("%Y-%m-%d %H:%M");

            // Scales. Note the inverted domain for the y-scale: bigger is up!
            x = d3.time.scale().range([0, w]);
            y = d3.scale.linear().range([h, 0]);
            xAxis = d3.svg.axis().scale(x).orient("bottom");
            yAxis = d3.svg.axis().scale(y).orient("left");

            // An area generator.
            area = d3.svg.area()                
                .x(function (d) {
                    return x(d.date);
                })
                .y0(h)
                .y1(function (d) {
                    if (!isNaN(d.flows))
                        return y(d.flows);
                    else
                        return y(0);
                });

                svg = d3.select("#chart").append("svg:svg")
                .attr("width", w + m[1] + m[3])
                .attr("height", h + m[0] + m[2])
              .append("svg:g")
                .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

            svg.append("svg:clipPath")
                .attr("id", "clip")
              .append("svg:rect")
                .attr("x", x(0))
                .attr("y", y(1))
                .attr("width", x(1) - x(0))
                .attr("height", y(0) - y(1));

            svg.append("svg:g")
                .attr("class", "y axis");

            svg.append("svg:path")
                .attr("class", "area")
                .attr("clip-path", "url(#clip)")
                .style("fill", "#0071c5");      

            svg.append("svg:g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + h + ")");

            rect = svg.append("svg:rect")
                .attr("class", "pane")
                .attr("width", w)
                .attr("height", h);

            d3.csv("dataset/ingest_summary.csv", function (data) {

                // Parse dates and numbers.
                data.forEach(function (d) {
                    d.date = parse(d.date);
                    d.flows = +d.flows;
                });

                data.sort(function (a, b) {
                    return a.date - b.date;
                });
                x.domain([d3.min(data, function (d) { return d.date; }), d3.max(data, function (d) { return d.date; })]);
                y.domain([0, d3.max(data, function (d) { return d.flows; })]);

                // Bind the data to our path elements.
                svg.select("path.area").datum(data);

                //svg.select("path.line").data([data]);

                rect.call(d3.behavior.zoom().x(x)
                  .scaleExtent([0.3, 2300])
                  .on("zoom", zoom));


                draw();

            });
        }
        function draw() {
            svg.select("g.x.axis").call(xAxis);
            svg.select("g.y.axis").call(yAxis);
            svg.select("path.area").attr("d", area);
            var numberFormat = d3.format(",d");
            //svg.select("path.line").attr("d", line);

            // this code updates the CX and CY attibutes of the circles so they can move along with the area and the line
            /*svg.selectAll("circle.point")
                .attr("cx", function (d) { return x(d.date); })
                .attr("cy", function (d) { return y(d.flows); });

            svg.selectAll("text.hover")
                .attr("x", function (d) { return x(d.date) + 5; })
                .attr("y", function (d) { return y(d.flows) - 10; });
            */
            d3.select("#range").html("Seeing total flows <strong>from:</strong> " + x.domain().map(format).join(" <strong>to:</strong> "));

            var flowsBetweenRange = $.map(d3.select("path.area").data()[0], function (obj) {
                if(obj.date >= x.domain()[0] && obj.date <= x.domain()[1]){
                    return obj.flows;
                }
            });

            var total = 0;

            for (var i = 0; i < flowsBetweenRange.length; i++) {
                if (!isNaN(flowsBetweenRange[i]))
                    total = total + flowsBetweenRange[i];
            }

            d3.select("#total").html("<strong>Total netflows in range:</strong> " + numberFormat(total));


            //rect.style("cursor", "move");
        }

        function zoom() {
            //d3.event.transform(x); // TODO d3.behavior.zoom should support extents
            if (d3.event.sourceEvent.type == "wheel") {
                if (d3.event.sourceEvent.wheelDelta < 0)
                    rect.style("cursor", "zoom-out");
                else
                    rect.style("cursor", "zoom-in");
            }
            else if (d3.event.sourceEvent.type == "mousemove") {
                rect.style("cursor", "e-resize");
            }
            draw();
        }

        $(function () {

            buildGraph();

            $(window).resize(function () {
                $('#chart').html("");
                buildGraph();
            });
        });


    </script>
</body>
</html>
